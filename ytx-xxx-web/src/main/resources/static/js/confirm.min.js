!function(){function a(){this.addressOuter=$("#addressOuter"),this.showAddressBtn=$("#allAddress"),this.hideAddressBtn=$("#hiddenAddress"),this.createAddressCon=$("#createAddressCon"),this.ajaxFlag=!0,this.orderMain=$("#orderMain"),this.total=$("#J_disTotal"),this.rbOptions=this.orderMain.find(".RB-select").find("option"),this.layerTipIndex=null,this.addressEditId="",this.totalPrice=$("#J_total"),this.point=$("#J_point"),this.ajaxTime=null,this.areaDesc=$("#areaDesc"),this.townDesc=$("#townDesc"),this.redbag=$("#redbag"),this.redbagDiscount=$("#redbagDiscount"),this.redbagDiscountOuter=$("#redbagDiscountOuter"),this.itemTotalPrice=document.getElementById("itemTotalPrice"),this.couponSelect=$(".J_couponSelect"),this.scrollTop=$("#scrollTop"),this.areaNumber=$("#areaNumber"),this.phoneNumber=$("#phoneNumber"),this.extensionNumber=$("#extensionNumber"),this.mphonerror=$("#mphone-error"),this.mPhone=$(".m-phone"),this.addressParent=$("#addressParent")}function b(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)","i"),c=window.location.search.substr(1).match(b);return null!=c?decodeURIComponent(c[2]):null}a.prototype={bind_events:function(){var a=this;return a.showAddressBtn.bind("click",function(){a.address_show()}),a.hideAddressBtn.bind("click",function(){a.address_hide()}),a.addressOuter.delegate(".J_address","click",function(){$("#addressInput").val(this.getAttribute("data-id")),document.getElementById("hiddenForm").submit()}).delegate(".J_edit","click",function(b){b.stopPropagation(),a.edit_address($(this))}),$("#createAddress").bind("click",function(){a.show_address()}),$("#createAddr_cancel").bind("click",function(){a.addressEditId="",a.createAddressCon.hide()}),a.couponSelect.bind("change",function(){a.select_coupon($(this))}),a.redbag.bind("change",function(){a.select_redbag(this)}),$("#confirmOrder").bind("click",function(){a.confirm_order()}),$(".J_invoice").bind("click",function(){a.invoice_controller(this)}),$(".J_invoiceType").bind("click",function(){a.invoice_type($(this))}),$(".J_saveInvoice").bind("click",function(){a.save_invoice($(this))}),$(".J_cancelInvoice").bind("click",function(){$(this).parents(".J_hiddenInvoice").hide(),$(this).parents(".J_hiddenInvoice").siblings(".J_invoiceCheck").find(".J_invoice").removeAttr("checked")}),$(".J_invoice-edit").bind("click",function(){a.edit_invoice($(this))}),$(".J_companyName").bind("blur",function(){a.check_company_name($(this).val(),$(this).siblings(".J_invoiceAlert"))}),$(".J_question").bind("mouseover",function(){a.layerTipIndex=layer.tips('<div> <p class="tal">1  发票类型：目前只支持开具普通发票</p> <p class="tal">2  发票金额：以实付金额为准，不包含运费金额以及优惠券、满减、红包等。</p> <p class="tal">3  发票内容：发票内容根据购买商品所属分类确定。</p> </div>',$(this),{tips:[1,"#f9f9f9"],time:9999999,area:["310px","100px"],skin:"tip-skin"})}).bind("mouseout",function(){layer.close(a.layerTipIndex)}),$("#usePoint").bind("change",function(){a.usePoint(this)}),$(".J_expressCost").bind("change",function(){var b=$(this);b.siblings(".J_expressText").text(b.val().split(",")[0]),a.calculate()}),$(document).delegate(".J-getAddress","change",function(){var b=$(this).val(),c=$(this).attr("data-tree");return 3!==+c&&void a.getAddress(b,++c)}),$(window).scroll(function(){var b=$(document).scrollTop();a.scrollTop.val(b)}),setTimeout(function(){a.redbag.trigger("change")},0),a},init:function(){var a=this;return $("#createAddressForm").validate({debug:!0,errorClass:"addressError",rules:{street:{required:!0,minlength:5,maxlength:100,checkSpace:!0},zipCode:{digits:!0,rangelength:[6,6]},name:{required:!0,maxlength:25,checkSpace:!0},phone:{required:!0,cPhone:!0}},messages:{street:{required:"请填写您的详细地址",minlength:"详细地址不得少于5个字",maxlength:"详细地址不得多于100个字",checkSpace:"地址不能全为空格"},zipCode:{digits:"请输入正确的邮编",rangelength:"请输入正确的邮编"},name:{required:"请填写收货人姓名",maxlength:"收货人姓名不得多于25字",checkSpace:"姓名不能全为空格"},phone:{required:"请填写收件人手机号码",cPhone:"请填写11位正确格式的手机号码"}},submitHandler:function(){a.ajaxFlag&&(a.ajaxFlag=!1,a.save_address())}}),a.scrollTop.val(b("scrollTop")),$("html,body").animate({scrollTop:a.scrollTop.val()},100),a},address_hide:function(){var a=this,b=a.addressOuter.find("li");return b.length>3?(b.each(function(a,b){a>2&&(b.style.display="none")}),a.showAddressBtn.show()):a.showAddressBtn.hide(),a.hideAddressBtn.hide(),a},address_show:function(){var a=this;a.addressOuter.find("li").each(function(a,b){b.style.display="block"}),a.showAddressBtn.hide(),a.hideAddressBtn.show()},autoAddress:function(){var a="CN",b=0,c=this;c.getAddress(a,b),b++;for(var d=0;d<3;d++)c.getAddress(thymeleafData.address[d],b),thymeleafData.address[d]=null,b++},getAddress:function(a,b){var c=[],d=this;return a?void $.ajax({type:"get",async:!1,url:"/"+a+"/parent",success:function(e){return c=e.regionList,""!==a&&0!==e.regionList.length&&void d.createAddress(c,b)}}):(d.createAddress(c,b),!1)},createAddress:function(a,b){for(var c=this,d=["provinceCode","cityCode","areaCode","townCode"],e=["省：","市：","区：","县："],f=["请选择省份","请选择城市","请选择县区","请选择街道"],g=$("<span>"+e[b]+"</span>"),h=$(' <select name="'+d[b]+'" class="mr10 J-getAddress" id="'+d[b]+'" data-tree="'+b+'"><option value="">'+f[b]+"</option></select> "),i="",j=b;j<4;j++){var k=$("#"+d[j]+"Parent");k.length>0&&k.remove()}if(a.length>0){for(var l=0,m=a.length;l<m;l++)i=a[l].code===thymeleafData.address[b]?'<option selected="selected" value="'+a[l].code+'">'+a[l].name+"</option>":'<option value="'+a[l].code+'">'+a[l].name+"</option>",$(h).append(i);var n=$('<span id="'+d[b]+'Parent"></span>');n.append(g).append(h),c.addressParent.append(n)}},edit_address:function(a){var b=this,c=a.attr("data-id");c!==b.addressEditId&&(b.show_address(),b.addressEditId=c,$.post("/buy_directly/getAddressById",{id:c},function(a){if("true"===a.success){var c=a.address;if(thymeleafData.address[0]=c.provinceCode,thymeleafData.address[1]=c.cityCode,thymeleafData.address[2]=c.areaCode,thymeleafData.address[3]=c.townCode,b.autoAddress(),$("#zipCode").val(c.zip),$("#street").val(c.address),$("#name").val(c.consignee),$("#phone").val(c.mobile),null!==c.phone&&"null"!==c.phone&&""!==c.phone){var d=c.phone.split("-");b.areaNumber.val(d[0]),b.phoneNumber.val(d[1]),null!=d[2]&&"undefined"!=d[2]&&b.extensionNumber.val(d[2])}}}))},show_address:function(){var a=this;a.addressEditId="",a.createAddressCon.find("input,textarea").each(function(a,b){b.value=""});for(var b=0;b<4;b++)thymeleafData.address[b]=null;a.autoAddress(),a.createAddressCon.find("label.addressError").hide(),a.createAddressCon.is(":hidden")&&(a.createAddressCon.slideDown(),$("html,body").animate({scrollTop:a.createAddressCon.offset().top},100))},save_address:function(){var a,b=this,c=$("#provinceCode"),d=$("#cityCode"),e=$("#areaCode"),f=$("#townCode"),g=c.val(),h=d.val(),i=e.val(),j=f.val(),k=c.find(":selected").text(),l=d.find(":selected").text(),m=e.find(":selected").text(),n=f.find(":selected").text(),o=$("#zipCode").val(),p=/^(0[0-9]{2,3}\-)?([1-9][0-9]{6,7})+(\-[0-9]{1,4})?$/,q={provinceCode:g,province:k,cityCode:h,city:l,areaCode:i,area:m,townCode:j,town:n,zip:o?o:"000000",address:$("#street").val(),consignee:$("#name").val(),mobile:$("#phone").val(),phone:a};if(!c||""===g||null===g||!d||""===h||null===h)return b.addressParent.next().text("选择地址不正确"),b.addressParent.show(),b.ajaxFlag=!0,!1;if(e.length>0){if(!i)return b.addressParent.next().text("选择地址不正确"),b.addressParent.next().show(),b.ajaxFlag=!0,!1;b.addressParent.next().text("")}if(f.length>0){if(!j)return b.addressParent.next().text("选择地址不正确"),b.addressParent.next().show(),b.ajaxFlag=!0,!1;b.addressParent.next().text("")}if(a=""!==b.extensionNumber.val()?b.areaNumber.val()+"-"+b.phoneNumber.val()+"-"+b.extensionNumber.val():b.areaNumber.val()+"-"+b.phoneNumber.val(),""!==b.addressEditId&&(q.id=b.addressEditId),""!==b.areaNumber.val()||""!==b.phoneNumber.val()||""!==b.extensionNumber.val()){if(!p.test(a))return b.mphonerror.css("display","block"),b.ajaxFlag=!0,!1}else a="";q.phone=a,$.ajax({type:"post",url:"/buy_directly/updateAddress",data:q,dataType:"json",success:function(a){b.ajaxFlag=!0,"true"===a.success&&(""!==b.addressEditId?($("#addressInput").val(b.addressEditId),document.getElementById("hiddenForm").submit()):window.location.reload())}})},usePoint:function(){var a=this,b=document.getElementById("usePoint");try{b.checked?a.point.text((b.value/100).toFixed(2)).attr("data-value",b.value):a.point.text("0.00"),document.getElementById("selectedPoints").checked=b.checked}catch(a){}a.calculate()},calculate:function(){for(var a=this,b=a.orderMain.find(".J_seller"),c=0,d=0,e=0,f=b.length;e<f;e++){for(var g=b.eq(e),h=g.find(".J_orderItem"),i=0,j=0,k=h.length;j<k;j++){var l=h.eq(j);i+=parseFloat(l.find(".J_itemSum").text())}g.find(".J_orderAmount").text(i.toFixed(2));var m=parseFloat(g.find(".J_discountPrice").text());m=m?m:0;var n=parseFloat(g.find(".J_expressCost").val().split(",")[0]);g.find(".J_expressText").text(" ¥ "+n.toFixed(2));var o=parseFloat(g.find(".J_couponSelect option:selected").attr("data-denomination"));o=o?o:0,g.find(".J_couponText").text("- ¥ "+o.toFixed(2));var p=100*i-100*m-100*o;p=p>0?p:0,c+=p/100,p=(p+100*n)/100,g.find(".J_orderDisTotal").text(p.toFixed(2)),d+=p}a.totalPrice.text(d.toFixed(2));var q=a.redbagDiscount.text();return q&&(d-=parseFloat(a.redbagDiscount.text())),a.itemTotalPrice.value=c,a.point.length&&(d-=parseFloat(a.point.text())),d=d<0?0:d,a.total.text(d.toFixed(2)),a},select_coupon:function(a){var b=a.val().split(".");$("#coupon"+b[0]).val(b[1]),document.getElementById("hiddenForm").submit()},select_redbag:function(a){var b=this,c=$(a),d=c.val(),e=parseFloat(b.itemTotalPrice.value)-(d?parseFloat(d.split(",")[1]):0);d?(b.redbagDiscountOuter.show(),parseFloat(b.itemTotalPrice.value)<parseFloat(d.split(",")[1])?b.redbagDiscount.text(parseFloat(b.itemTotalPrice.value).toFixed(2)):b.redbagDiscount.text(parseFloat(d.split(",")[1]).toFixed(2))):(b.redbagDiscountOuter.hide(),b.redbagDiscount.text(0)),$("#defaultRedbagId").val(d?d.split(",")[0]:""),e=e<0?0:e,$.post("/buy_directly/getPointVO",{totalPrice:e},function(a){$("#usePoint").val(a.thisEnable),$("#pointText").html("￥<span>"+a.exchangeAmount+'</span><span class="ml10">你有<span>'+a.points+"</span>个，本次可用<span>"+a.thisEnable+"</span>个</span>"),b.usePoint()})},confirm_order:function(){var a=this,b=$("#addressList").find(".active");if(!b.length)return void layer.msg("请选择一个收货地址或者添加一个收货地址");for(var c=a.orderMain.find(".J_seller"),d=[],e=0,f=c.length;e<f;e++){for(var g=c.eq(e),h=g.find(".J_orderItem"),i=[],j=0,k=h.length;j<k;j++){var l=h.eq(j),m=l.find(".J_itemAccount").eq(0),n={itemskuid:m.attr("data-itemskuid"),value:m.attr("data-value"),marketPrice:m.attr("data-marketprice"),onSalePrice:m.attr("data-onsaleprice")};i.push(n)}var o=g.find(".J_expressCost").val().split(","),p={sellerId:g.attr("data-selleracountid"),remark:g.find(".J_remark").val(),items:i,deliveryFee:o[0],vendor:"1"===$("#deliveryFreeFee").val()?0:o[1],discountList:{activityId:g.attr("data-activityId"),updatedA:g.attr("data-updatedAt")},couponId:g.find(".J_couponSelect").val()?g.find(".J_couponSelect").val().split(".")[1]:0};if(g.find(".J_invoice")[0].checked&&g.find(".J_saveInvoice").is(":visible"))return void layer.msg("请先保存发票信息");if("block"===g.find(".J_invoiceChooszen")[0].style.display){var q,r=g.find(".J_invoiceType:checked").val();q=1===parseInt(r)?{type:r}:{type:r,name:g.find(".J_companyName").val()},p.invoice=q}var s={seller:p};d.push(s)}var t={id:b.attr("data-id"),buyDirectly:$("#J_buyWay").val(),sellers:d,RPid:a.redbag.val()?a.redbag.val().split(",")[0]:null};try{document.getElementById("usePoint").checked&&(t.points=parseFloat(a.point.attr("data-value")))}catch(a){}a.ajaxFlag&&(a.ajaxFlag=!1,$.ajax({type:"post",url:"/ajax/order_submit",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(t),success:function(b){switch(a.ajaxFlag=!0,b.success){case"true":window.location.href=b.redirectUrl;break;case"false":layer.open({title:"提示",content:"~（>_<)购买的商品已失效<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"area_limit_sale":layer.open({title:"提示",content:"~（>_<)当前区域限购<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalidate_delivery_fee":layer.open({title:"提示",content:"~（>_<)~亲，运费信息有更新<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalidate_redbag":layer.open({title:"提示",content:"~（>_<)~使用了失效的红包<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalidate_item":layer.open({title:"提示",content:"~（>_<)~部分商品信息发生变化<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalidate_stocklimit":layer.open({title:"提示",content:"~（>_<)~商品库存不足<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"address_invalid":layer.open({title:"提示",content:"~（>_<)~收货地址不存在<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"failed":layer.open({title:"提示",content:"~（>_<)~商品不存在<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"unlogin":window.location.href=b.redirectUrl+"?redirect="+encodeURIComponent(window.location.href);break;case"invalidate_item_canbylimit":layer.open({title:"提示",content:"~（>_<)~订单生成失败<br/>订单中的部分商品已经达到限购数,无法购买",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalid_coupon":layer.open({title:"提示",content:"~（>_<)~订单生成失败<br/>"+b.msg,skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"invalidate_points":layer.open({title:"提示",content:"~（>_<)~订单生成失败<br/>积分失效,购买失败",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}});break;case"bigDiscount_invalid":layer.open({title:"提示",content:"~（>_<)~满减信息有更新<br/>请点击确认更新数据",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.reload()}})}},error:function(){a.ajaxFlag=!0}}))},invoice_controller:function(a){var b;b=$(a).hasClass("J_invoice")?$(a).parent().siblings(".J_hiddenInvoice"):$(a).parents(".J_hiddenInvoice"),a.checked?b.show():(b.find(".invoice-radio").each(function(a,b){b.checked=!1}),b.find(".J_companyName").val(""),b.hide())},invoice_type:function(a){1===parseInt(a.val())?(a.siblings(".J_companyName").val(""),a.siblings(".J_invoiceAlert").text(""),a.siblings(".J_companyName").hide()):a.siblings(".J_companyName").show()},save_invoice:function(a){var b=this,c=a.parents(".J_hiddenInvoice").find(".J_invoiceType:checked").val(),d="";switch(c){case"1":d="个人",b.write_invoice(d,a);break;case"2":var e=a.parents(".J_hiddenInvoice").find(".J_companyName");b.check_company_name(e.val(),a.parents(".J_hiddenInvoice").find(".J_invoiceAlert"))&&(d="公司/"+e.val(),b.write_invoice(d,a));break;default:layer.msg("请先选择发票类型!")}},check_company_name:function(a,b){var c=/\s/;return c.test(a)||""===a?(b.text("请正确输入公司名称"),!1):(b.text(""),!0)},write_invoice:function(a,b){var c=b.parents(".J_hiddenInvoice");c.siblings(".J_invoiceCheck").hide(),c.hide(),c.parents(".J_invoiceCon").find(".J_invoiceChooszen").show().find(".J_invoice-chooszen").text(a)},edit_invoice:function(a){var b=a.parents(".J_invoiceCon");b.find(".J_hiddenInvoice").show(),b.find(".J_invoiceCheck").show(),a.parent().hide()},check_item_status:function(){var a=this,b=$("#userAlert").val(),c=$("#needRedirect").val();return""!==b&&layer.open({title:"提示",content:"~（>_<)~部分商品信息发生变化<br/>点击确认刷新当前页面重新确定订单",skin:"confirm-skin",btn:"确定",move:0,area:["434px"],end:function(){window.location.href=c}}),a}};var c=new a;c.bind_events().address_hide().init().calculate()}();